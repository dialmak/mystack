# mystack docker


## Створюємо та запускаємо контейнери

Клонуємо репозиторій, переходимо в папку з docker-compose.yml та створюємо іміджі контейнерів:

```bash
cd .. && sudo rm -r mystack/
clear && cd ~ && git clone https://github.com/dialmak/mystack.git && cd mystack && docker compose build
```

Запускаємо  контейнери у фоновому режимі:

```bash
docker compose up -d
```


##  Додаємо користувачів до mosquitto

Заходимо в контейнер mosquitto
```bash
docker exec -it -u 1883 my-mosquitto sh
```

Якщо ви хочете додати більше користувачів до файлу паролів, скористайтеся командою 

```bash
mosquitto_passwd -b /mosquitto/config/passwd_file user_name user_password
```

Змінюємо права на файл тільки для власника, інші не мають права читати цей файл
```bash
chmod 0700 /mosquitto/config/passwd_file
```

Тепер вийдіть із контейнера за допомогою команди `exit` і перезапустіть його за допомогою 

```bash
docker restart mqtt
```

Після цього ваші зміни будуть застосовані до брокера.

## MQTTX клієнт

Команди тут [https://mqttx.app/docs/cli/get-started](https://mqttx.app/docs/cli/get-started)

```bash
# Вбудовані сценарії 
mqttx ls -sc
# Підключення до серверу та підписка на все
mqttx sub -v -i 'mqttx_test' -t '#'-h 'mqtt' -p 1883 -u 'mqttx' -P 'osa00NET'
# Приклад запуску скрипта симуляції
mqttx simulate -v -i 'mqttx_%i' -t 'test/%c' -sc 'IEM'  -h 'mqtt' -p 1883 -u 'mqttx' -P 'osa00NET'
```

## Дані

| Топік             | Приклад    | Діапазон               | Коментарії                                                   |
| ----------------- | ---------- | ---------------------- | ------------------------------------------------------------ |
| client_id         |            |                        |                                                              |
| timestamp_unix    | 1707766866 | від 1707766866 та вище | Мітка часу Unix                                              |
| ac_voltage        | 220        | від 90 до 270          | Напруга в мережі, В                                          |
| out_current       | 10         | від 0 до 100           | Вихідний струм ІПКЗ, А                                       |
| out_voltage       | 50         | від 0 до 100           | Вихідна напруга ІПКЗ, В                                      |
| potential_voltage | -1.20      | від -10 до +5          | Захисний потенціал відносно мідно-сульфатного електрода порівняння (МЕП), В |
| potential_state   | 1          | від 0 до 4             | Стан МЕП:<br/>0 - Обрив МЕП, якщо МЕП був підключений, але зараз в обриві<br/>1 - Нормальний стан МЕП<br/>2 - Коротке замикання МЕП, якщо МЕП був підключений, але зараз має КЗ<br/>3 - МЕП не підключений, якщо МЕП немає |
| temp_ambient      | 25         | від -40 до +85         | Температура в шафі ІПКЗ, °С                                  |
| temp_power_unit   | 70         | від -40 до +85         | Температура радіатора силового блоку ІПКЗ , °С               |
| time_work         | 120000     | від 0 до 200000        | Час напрацювання, год                                        |
| electric_meter    | 2300       | від 0 до 99999         | Показники лічильника, кВт*год                                |
| mode              | 1          | від 0 до 6             | Режим роботи ІПКЗ:<br/>0 - відключений, <br/>1 - режим стабілізації захисного потенціалу,<br/>2 - режим стабілізації струму,<br/>3 - режим стабілізації напруги,<br/>4 - режим налаштування стабілізації захисного потенціалу,<br/>5 - режим налаштування стабілізації струму,<br/>6 - режим налаштування стабілізації напруги |
| state             | 1          | від 0 до 7             | Стан ІПКЗ:<br/>0 - Режим очікування / Power OFF<br/>1 - Включений, стан в нормі / Power OK <br/>2 - Немає вхідної напруги змінного струму 220 V / AC Input Fail<br/>3 - Помилка блока AUX або основного імпульсного блока живлення  / AUX or SMPS Fail<br/>4 - Сигналізація про високу, понад 75°C, внутрішню температуру / High Temperature Alarm<br/>5 - Спрацював захист від перегріву, внутрішня температура понад 85°C  / OTP Shutdown<br/>6 - Спрацював захист від перенапруги / OVP Shutdown<br/>7 - Спрацював захист від перевантаження / OLP Shutdown |
| load_state        | 1          | від 0 до 2             | Стан навантаження:<br/>0 - Норма<br/>1 - Обрив, немає струму на виході ІПКЗ<br/>2 - Коротке замикання, ІПКЗ в режимі OLP Shutdown |
|                   |            |                        |                                                              |
|                   |            |                        |                                                              |

